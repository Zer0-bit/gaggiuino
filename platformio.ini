; PlatformIO Project Configuration File
;
;   Build options: build flags, source filter
;   Upload options: custom upload port, speed and extra flags
;   Library options: dependencies, extra library storages
;   Advanced options: extra scripting
;
; Please visit documentation for the other options and examples
; https://docs.platformio.org/page/projectconf.html

[platformio]
default_envs = blackpill

[env:blackpill]
framework = arduino
platform = ststm32@15.4.1
board = blackpill_f411ce
extra_scripts =
	pre:scripts/auto-version.py
	pre:scripts/custom-src-dir.py
custom_src_dir = src
upload_protocol = stlink
debug_tool = stlink
monitor_speed = 115200
lib_compat_mode = strict
lib_deps =
	robtillaart/ADS1X15@0.3.7
	khoih-prog/FlashStorage_STM32@1.2.0
	adafruit/MAX6675 library@1.1.0
	; adafruit/Adafruit MAX31855 library@1.3.0
	https://github.com/Seithan/EasyNextionLibrary.git#4bd06b2a428da3cfd17f54dfd654ff2da6867ddb
	https://github.com/banoz/PSM.Library.git#8f87ae0a67ace095c43bdbc661ffea72d4664b4c
	https://github.com/banoz/HX711.git#cf81533c54abe259ef61d457d7db6eef94f6ea25

build_flags =
	-DPIO_FRAMEWORK_ARDUINO_ENABLE_CDC
	-DUSBCON
	-DLOG_LEVEL=3
	-DDEBUG_ENABLED
	-DPIO_FRAMEWORK_ARDUINO_STANDARD_LIB
	-DENABLE_HWSERIAL2
	-DPIN_SERIAL2_RX=PA3
	-DPIN_SERIAL2_TX=PA2
	-Wdouble-promotion -Wall
	-DSINGLE_HX711_CLOCK ;Comment if using dual scales clock lines

[env:esp32]
framework = arduino
platform = espressif32
board = esp32dev
extra_scripts =
	pre:scripts/auto-version.py
	pre:scripts/custom-src-dir.py
custom_src_dir = src
upload_speed = 921600
monitor_speed = 115200
lib_compat_mode = strict
lib_deps =
	robtillaart/ADS1X15@0.3.7
	khoih-prog/FlashStorage_STM32@1.2.0
	adafruit/MAX6675 library@1.1.0
	; adafruit/Adafruit MAX31855 library@1.3.0
	https://github.com/Seithan/EasyNextionLibrary.git#4bd06b2a428da3cfd17f54dfd654ff2da6867ddb
	https://github.com/banoz/PSM.Library.git#8f87ae0a67ace095c43bdbc661ffea72d4664b4c
	https://github.com/banoz/HX711.git#cf81533c54abe259ef61d457d7db6eef94f6ea25

build_flags =
	'-D LOG_LEVEL=3'
	'-D DEBUG_ENABLED'
	-Wdouble-promotion -Wall
	'-D SINGLE_HX711_CLOCK' ;Comment if using dual scales clock lines
	
	; ESP32 pin definitions
	'-D PINDEF_H'

	; Thermocouple VSPI
	'-D thermoDO=19'
	'-D thermoCS=23'
	'-D thermoCLK=5'

	; AC Dimmer
	'-D zcPin=34'
	'-D dimmerPin=32'
	
	; Input
	'-D brewPin=26'
	'-D steamPin=27'
	
	; Outputs
	'-D relayPin=33'
	'-D valvePin=25'
	
	; Scales
	'-D HX711_sck_1=PB0'
	'-D HX711_sck_2=PB1'
	'-D HX711_dout_1=PB8'
	'-D HX711_dout_2=PB9'
	
	; I2C ADS1115
	'-D I2C_SDA=2'
	'-D I2C_SCL=4'

	; Front Panel (PCF8574)
	'-D powerLEDPin=P0'
	'-D brewLEDPin=P1'
	'-D steamLEDPin=P2'
	'-D brewSWPin=P4'
	'-D steamSWPin=P5'
	
	'-D USART_LCD=Serial2' ; UART2 - GPIO16 / GPIO17
	'-D USART_DEBUG=Serial'  ; UART0 - GPIO3 / GPIO1

[env:blackpill-relay]
extends = env:blackpill
build_flags = -DLEGO_VALVE_RELAY

[env:blackpill-dfu]
extends = env:blackpill
upload_protocol = dfu

[env:scales]
extends = env:blackpill
custom_src_dir = scales-calibration

[env:scales-dfu]
extends = env:scales
upload_protocol = dfu

[env:test]
platform = native@1.2.1
build_flags = -std=gnu++11 -include test/mock.h
lib_deps =
	ArduinoFake
test_build_src=true
